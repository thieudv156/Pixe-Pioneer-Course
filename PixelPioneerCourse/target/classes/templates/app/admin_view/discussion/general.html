<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}">
  <head>
    <title>Pixel Pioneer Course - Discussion General</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.ckeditor.com/4.16.2/standard/ckeditor.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
	<style>
		table thead tr th a {
			font-size: 16px;
		}
	</style>
  </head>
  <body>
    <div class="content-wrapper" layout:fragment="contents">
      <div class="container">
        
      </div>
      <div class="container page__container page-section">
				    <div class="page-separator">
				        <div class="page-separator__text" style="font-size: 18px;">List of discussion</div>
				    </div>
					<div class="d-flex align-items-center navbar-height">
			            <form id="search-form" th:action="@{/app/admin/discussion}" method="post" class="search-form search-form--black mx-16pt pr-0 pl-16pt" style="color: white; width: 37vw;">
			              <input type="text" id="search-input" style="color: white;" name="query" class="form-control pl-0" placeholder="Search discussion (with user full name or course name)">
			              <button type="submit" class="btn btn-dark btn-rounded" style="color: white;">Search</button>
			            </form>
			        </div>
				    <div class="">
				        <div class="table-responsive"
				             data-toggle="lists"
				             data-lists-sort-by="js-lists-values-employee-name"
				             data-lists-values='["js-lists-values-employee-name", "js-lists-values-employer-name", "js-lists-values-projects", "js-lists-values-activity", "js-lists-values-earnings"]'>
				            <!-- Add conditionals for error and success messages -->
				            <div th:if="${ErrorCondition}" class="alert alert-danger" role="alert">
				                <span style="color: red; font-weight: bold;" th:text="${ErrorError}"></span>
				            </div>
				            <div th:if="${SuccessCondition}" class="alert alert-primary" role="alert">
				                <span style="color: green; font-weight: bold;" th:text="${SuccessSuccess}"></span>
				            </div>
				
				            <table class="table mb-0 thead-border-top-0 table-nowrap">
				                <thead>
				                    <tr style="font-size: 16px;">
				                        <th><a  >Role</a></th>
				                        <th style="width: 150px;"><a   style="color: crimson;">Content</a></th>
				                        <th style="width: 150px;"><a  >User fullname</a></th>
				                        <th style="width: 150px;"><a  >User email</a></th>
				                        <th style="width: 150px;"><a  >Sub-lesson</a></th>
				                        <th style="width: 150px;"><a  >Sub-lesson ID</a></th>
				                        <th style="width: 150px;"><a  >Lesson</a></th>
				                        <th style="width: 150px;"><a  >Lesson ID</a></th>
				                        <th style="width: 150px;"><a  >Course</a></th>
				                        <th style="width: 150px;"><a  >Course ID</a></th>
				                        <th style="width: 150px;"><a  >Posted Date</a></th>
				                        <th style="width: 150px;"><a  >Action</a></th>
				                    </tr>
				                </thead>
				                <tbody class="list" id="discussion">
								    <tr th:each="discussionData : ${discussionsData}" class="selected" style="font-size: 15px;">
								        <td th:text="${discussionData[0].substring(5)}">Role</td>
								        <td th:text="${discussionData[1]}">Content</td>
								        <td th:text="${discussionData[2]}">User fullname</td>
								        <td th:text="${discussionData[3]}">User email</td>
								        <td th:text="${discussionData[4]}">Sub-lesson</td>
								        <td th:text="${discussionData[5]}">Sub-lesson ID</td>
								        <td th:text="${discussionData[6]}">Lesson</td>
								        <td th:text="${discussionData[7]}">Lesson ID</td>
								        <td th:text="${discussionData[8]}">Course</td>
								        <td th:text="${discussionData[9]}">Course ID</td>
								        <td th:text="${discussionData[10]}">Posted Date</td>
								        <td>
								            <div style="display: flex;">
											    <form id="delete" th:action="@{/app/admin/discussion/delete}" method="post" style="margin: 0;">
											      <input type="hidden" th:value="${discussionData[11]}" name="id" />
											      <button type="submit" class="btn btn-dark btn-rounded">Delete</button>
											    </form>
											    <button class="btn btn-warning btn-rounded ml-2" th:attr="onclick='showWarningEditor(' + ${discussionData[11]} + ')'">Send Warning</button>
												<script>
												function showWarningEditor(discussionId) {
												    Swal.fire({
												        title: 'Your warning message for discussion ' + discussionId,
												        html: `
												            <textarea id="warningContent" name="warningContent" rows="5" style="width: 100%;"></textarea>
												        `,
												        icon: 'warning',
												        showCancelButton: true,
												        confirmButtonText: 'Send Warning',
												        preConfirm: () => {
												            return {
												                warningContent: CKEDITOR.instances.warningContent.getData(),
												                reviewId: discussionId
												            };
												        }
												    }).then((result) => {
												        if (result.isConfirmed) {
												            var warningContent = result.value.warningContent;
												            var reviewId = result.value.discussionId;
												
												            // Print the value to the console for debugging
												            console.log("Warning Content:", warningContent);
												            console.log("Discussion ID:", discussionId);
												
												            // Perform the AJAX request here
												            var xhr = new XMLHttpRequest();
												            xhr.open("POST", "/app/admin/discussion/warn", true);
												            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
												
												            xhr.onreadystatechange = function () {
												                if (xhr.readyState === 4 && xhr.status === 200) {
												                    Swal.fire('Sent!', 'Your warning message has been sent.', 'success');
												                }
												            };
												
												            var params = "discussionId=" + encodeURIComponent(discussionId) + "&warningContent=" + encodeURIComponent(warningContent);
												            xhr.send(params);
												        }
												    });
												
												    // Initialize CKEditor after SweetAlert has rendered the textarea
												    setTimeout(() => {
												        CKEDITOR.replace('warningContent', {
												            toolbar: [
												                { name: 'basicstyles', items: ['Bold', 'Italic'] },
												                { name: 'paragraph', items: ['Indent', 'Outdent'] }
												            ],
												            removePlugins: 'resize'
												        });
												    }, 100);
												}
												</script>
										  </div>
								        </td>
								    </tr>
								</tbody>

                            </table>
                        </div>

                        <div class="card-footer p-8pt">
            				<ul class="pagination justify-content-start pagination-xsm m-0" id="pagination">
                                <li class="page-item">
                                    <a class="page-link"
                                       href="#"
                                       aria-label="Page 1">
                                        <span>1</span>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link"
                                       href="#"
                                       aria-label="Page 2">
                                        <span>2</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <script>
	                       	document.addEventListener('DOMContentLoaded', function() {
	                            const users = document.querySelectorAll('#discussion tr');
	                            const pagination = document.getElementById('pagination');
	                            const itemsPerPage = 5;
	                            let currentPage = 1;
	                            const pageCount = Math.ceil(users.length / itemsPerPage);
	
	                            function showPage(page) {
	                                currentPage = page;
	                                const start = (page - 1) * itemsPerPage;
	                                const end = start + itemsPerPage;
	
	                                users.forEach((user, index) => {
	                                    user.style.display = (index >= start && index < end) ? '' : 'none';
	                                });
	
	                                updatePagination();
	                            }
	
	                            function updatePagination() {
	                                pagination.innerHTML = '';
	
	                                const prevPageItem = document.createElement('li');
	                                prevPageItem.className = 'page-item ' + (currentPage === 1 ? 'disabled' : '');
	                                pagination.appendChild(prevPageItem);
	
	                                for (let i = 1; i <= pageCount; i++) {
	                                    const pageItem = document.createElement('li');
	                                    pageItem.className = 'page-item ' + (i === currentPage ? 'active' : '');
	                                    pageItem.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
	                                    pagination.appendChild(pageItem);
	                                }
	
	                                const nextPageItem = document.createElement('li');
	                                nextPageItem.className = 'page-item ' + (currentPage === pageCount ? 'disabled' : '');
	                                pagination.appendChild(nextPageItem);
	                            }
	
	                            pagination.addEventListener('click', function(e) {
	                                const page = e.target.getAttribute('data-page');
	                                if (page) {
	                                    showPage(parseInt(page));
	                                }
	                            });
	
	                            showPage(1);
	                        });				
                        </script>
                    </div>
                </div>
    </div>
  </body>
</html>
